
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Handoff &#8212; Riak Core Tutorial 1.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Coverage Calls" href="coverage-calls.html" />
    <link rel="prev" title="Quorum Requests" href="quorum-requests.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="handoff">
<h1>Handoff<a class="headerlink" href="#handoff" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The content of this chapter is in the <cite>04-handoff</cite> branch.</p>
<p class="last"><a class="reference external" href="https://gitlab.com/marianoguerra/tanodb/tree/04-handoff">https://gitlab.com/marianoguerra/tanodb/tree/04-handoff</a></p>
</div>
<div class="section" id="how-it-works">
<h2>How it Works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>With quorum requests we are halfway in our way to tolerate failures in cluster
nodes, our values are written to more than one vnode but if a node dies and
another takes his work or if we add a new node and the vnodes must be
rebalanced we need to handle <a class="reference external" href="https://github.com/basho/riak_core/wiki/Handoffs">handoff</a>.</p>
<p>The reasons to start a handoff are:</p>
<ul class="simple">
<li>A ring update event for a ring that all other nodes have already seen.</li>
<li>A secondary vnode is idle for a period of time and the primary, original
owner of the partition is up again.</li>
</ul>
<p>When this happens riak_core will inform the vnode that handoff is starting,
calling <cite>handoff_starting</cite>, if it returns false it’s cancelled, if it returns
true it calls <cite>is_empty</cite>, that must return false to inform that the vnode has
something to handoff (it’s not empty) or true to inform that the vnode is
empty, in our case we ask for the first element of the ets table and if it’s
the special value ‘$end_of_table’ we know it’s empty, if it returns true the
handoff is considered finished, if false then a call is done to <cite>handle_handoff_command</cite>
passing as first parameter an opaque structure that contains two fields we are
insterested in, foldfun and acc0, they can be unpacked with a macro like this:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="nf">handle_handoff_command</span><span class="p">(</span><span class="o">?</span><span class="nv">FOLD_REQ</span><span class="p">{</span><span class="n">foldfun</span><span class="o">=</span><span class="nv">Fun</span><span class="p">,</span> <span class="n">acc0</span><span class="o">=</span><span class="nv">Acc0</span><span class="p">},</span> <span class="p">_</span><span class="nv">Sender</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>The <cite>FOLD_REQ</cite> macro is defined in the riak_core_vnode.hrl header file which we
include.</p>
<p>This function must iterate through all the keys it stores and for each of them
call foldfun with the key as first argument, the value as second argument and
the latest acc0 value as third.</p>
<p>The result of the function call is the new <cite>Acc0</cite> you must pass to the next
call to foldfun, the last <cite>Acc0</cite> must be returned by the handle_handoff_command.</p>
<p>For each call to <cite>Fun(Key, Entry, AccIn0)</cite> riak_core will send it to the new
vnode, to do that it must encode the data before sending, it does this by
calling <cite>encode_handoff_item(Key, Value)</cite>, where you must encode the data
before sending it.</p>
<p>When the value is received by the new vnode it must decode it and do something
with it, this is done by the function <cite>handle_handoff_data</cite>, where we decode the
received data and do the appropriate thing with it.</p>
<p>When we sent all the key/values <cite>handoff_finished</cite> will be called and then
<cite>delete</cite> so we cleanup the data on the old vnode .</p>
<p>You can decide to handle other commands sent to the vnode while the handoff is
running, you can choose to do one of the followings:</p>
<ul class="simple">
<li>Handle it in the current vnode</li>
<li>Forward it to the vnode we are handing off</li>
<li>Drop it</li>
</ul>
<p>What to do depends on the design of you app, all of them have tradeoffs.</p>
<p>The signature of all the responses is:</p>
<div class="code erlang highlight-default"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">callback</span> <span class="n">handle_handoff_command</span><span class="p">(</span><span class="n">Request</span><span class="p">::</span><span class="n">term</span><span class="p">(),</span> <span class="n">Sender</span><span class="p">::</span><span class="n">sender</span><span class="p">(),</span> <span class="n">ModState</span><span class="p">::</span><span class="n">term</span><span class="p">())</span> <span class="o">-&gt;</span>
<span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="n">Reply</span><span class="p">::</span><span class="n">term</span><span class="p">(),</span> <span class="n">NewModState</span><span class="p">::</span><span class="n">term</span><span class="p">()}</span> <span class="o">|</span>
<span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="n">NewModState</span><span class="p">::</span><span class="n">term</span><span class="p">()}</span> <span class="o">|</span>
<span class="p">{</span><span class="k">async</span><span class="p">,</span> <span class="n">Work</span><span class="p">::</span><span class="n">function</span><span class="p">(),</span> <span class="n">From</span><span class="p">::</span><span class="n">sender</span><span class="p">(),</span> <span class="n">NewModState</span><span class="p">::</span><span class="n">term</span><span class="p">()}</span> <span class="o">|</span>
<span class="p">{</span><span class="n">forward</span><span class="p">,</span> <span class="n">NewModState</span><span class="p">::</span><span class="n">term</span><span class="p">()}</span> <span class="o">|</span>
<span class="p">{</span><span class="n">drop</span><span class="p">,</span> <span class="n">NewModState</span><span class="p">::</span><span class="n">term</span><span class="p">()}</span> <span class="o">|</span>
<span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="n">Reason</span><span class="p">::</span><span class="n">term</span><span class="p">(),</span> <span class="n">NewModState</span><span class="p">::</span><span class="n">term</span><span class="p">()}</span><span class="o">.</span>
</pre></div>
</div>
<p>A diagram of the flow is as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">+-----------+</span>      <span class="o">+----------+</span>        <span class="o">+----------+</span>
<span class="o">|</span>           <span class="o">|</span> <span class="n">true</span> <span class="o">|</span>          <span class="o">|</span> <span class="n">false</span>  <span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span> <span class="n">Starting</span>  <span class="o">+------&gt;</span> <span class="n">is_empty</span> <span class="o">+--------&gt;</span> <span class="n">fold_req</span> <span class="o">|</span>
<span class="o">|</span>           <span class="o">|</span>      <span class="o">|</span>          <span class="o">|</span>        <span class="o">|</span>          <span class="o">|</span>
<span class="o">+-----+-----+</span>      <span class="o">+----+-----+</span>        <span class="o">+----+-----+</span>
      <span class="o">|</span>                 <span class="o">|</span>                   <span class="o">|</span>
      <span class="o">|</span> <span class="n">false</span>           <span class="o">|</span> <span class="n">true</span>              <span class="o">|</span> <span class="n">ok</span>
      <span class="o">|</span>                 <span class="o">|</span>                   <span class="o">|</span>
<span class="o">+-----</span><span class="n">v</span><span class="o">-----+</span>           <span class="o">|</span>              <span class="o">+----</span><span class="n">v</span><span class="o">-----+</span>     <span class="o">+--------+</span>
<span class="o">|</span>           <span class="o">|</span>           <span class="o">|</span>              <span class="o">|</span>          <span class="o">|</span>     <span class="o">|</span>        <span class="o">|</span>
<span class="o">|</span> <span class="n">Cancelled</span> <span class="o">|</span>           <span class="o">+--------------&gt;</span> <span class="n">finished</span> <span class="o">+-----&gt;</span> <span class="n">delete</span> <span class="o">|</span>
<span class="o">|</span>           <span class="o">|</span>                          <span class="o">|</span>          <span class="o">|</span>     <span class="o">|</span>        <span class="o">|</span>
<span class="o">+-----------+</span>                          <span class="o">+----------+</span>     <span class="o">+--------+</span>
</pre></div>
</div>
</div>
<div class="section" id="implementing-it">
<h2>Implementing it<a class="headerlink" href="#implementing-it" title="Permalink to this headline">¶</a></h2>
<p>We need to add logic to all the empty callbacks related to handoff:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="nf">handle_handoff_command</span><span class="p">(</span><span class="o">?</span><span class="nv">FOLD_REQ</span><span class="p">{</span><span class="n">foldfun</span><span class="o">=</span><span class="nv">FoldFun</span><span class="p">,</span> <span class="n">acc0</span><span class="o">=</span><span class="nv">Acc0</span><span class="p">},</span> <span class="p">_</span><span class="nv">Sender</span><span class="p">,</span>
                       <span class="nv">State</span><span class="o">=</span><span class="nl">#state</span><span class="p">{</span><span class="n">partition</span><span class="o">=</span><span class="nv">Partition</span><span class="p">,</span> <span class="n">kv_state</span><span class="o">=</span><span class="nv">KvState</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nn">lager</span><span class="p">:</span><span class="nf">info</span><span class="p">(</span><span class="s">&quot;fold req </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Partition</span><span class="p">]),</span>
    <span class="nv">KvFoldFun</span> <span class="o">=</span> <span class="k">fun</span> <span class="p">({</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">},</span> <span class="nv">AccIn</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="nn">lager</span><span class="p">:</span><span class="nf">info</span><span class="p">(</span><span class="s">&quot;fold fun </span><span class="si">~p</span><span class="s">: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">]),</span>
                        <span class="nv">FoldFun</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">,</span> <span class="nv">AccIn</span><span class="p">)</span>
                <span class="k">end</span><span class="p">,</span>
    <span class="p">{</span><span class="nv">AccFinal</span><span class="p">,</span> <span class="nv">KvState1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">tanodb_kv_ets</span><span class="p">:</span><span class="nf">foldl</span><span class="p">(</span><span class="nv">KvFoldFun</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">,</span> <span class="nv">KvState</span><span class="p">),</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">AccFinal</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">kv_state</span><span class="o">=</span><span class="nv">KvState1</span><span class="p">}};</span>

<span class="nf">handle_handoff_command</span><span class="p">(</span><span class="nv">Message</span><span class="p">,</span> <span class="p">_</span><span class="nv">Sender</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">lager</span><span class="p">:</span><span class="nf">warning</span><span class="p">(</span><span class="s">&quot;handoff command </span><span class="si">~p</span><span class="s">, ignoring&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Message</span><span class="p">]),</span>
    <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>

<span class="nf">handoff_starting</span><span class="p">(</span><span class="nv">TargetNode</span><span class="p">,</span> <span class="nv">State</span><span class="o">=</span><span class="nl">#state</span><span class="p">{</span><span class="n">partition</span><span class="o">=</span><span class="nv">Partition</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nn">lager</span><span class="p">:</span><span class="nf">info</span><span class="p">(</span><span class="s">&quot;handoff starting </span><span class="si">~p</span><span class="s">: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Partition</span><span class="p">,</span> <span class="nv">TargetNode</span><span class="p">]),</span>
    <span class="p">{</span><span class="n">true</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>

<span class="nf">handoff_cancelled</span><span class="p">(</span><span class="nv">State</span><span class="o">=</span><span class="nl">#state</span><span class="p">{</span><span class="n">partition</span><span class="o">=</span><span class="nv">Partition</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nn">lager</span><span class="p">:</span><span class="nf">info</span><span class="p">(</span><span class="s">&quot;handoff cancelled </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Partition</span><span class="p">]),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>

<span class="nf">handoff_finished</span><span class="p">(</span><span class="nv">TargetNode</span><span class="p">,</span> <span class="nv">State</span><span class="o">=</span><span class="nl">#state</span><span class="p">{</span><span class="n">partition</span><span class="o">=</span><span class="nv">Partition</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nn">lager</span><span class="p">:</span><span class="nf">info</span><span class="p">(</span><span class="s">&quot;handoff finished </span><span class="si">~p</span><span class="s">: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Partition</span><span class="p">,</span> <span class="nv">TargetNode</span><span class="p">]),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>

<span class="nf">handle_handoff_data</span><span class="p">(</span><span class="nv">BinData</span><span class="p">,</span> <span class="nv">State</span><span class="o">=</span><span class="nl">#state</span><span class="p">{</span><span class="n">kv_state</span><span class="o">=</span><span class="nv">KvState</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nv">TermData</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">BinData</span><span class="p">),</span>
    <span class="nn">lager</span><span class="p">:</span><span class="nf">info</span><span class="p">(</span><span class="s">&quot;handoff data received </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">TermData</span><span class="p">]),</span>
    <span class="p">{{</span><span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Key</span><span class="p">},</span> <span class="nv">Value</span><span class="p">}</span> <span class="o">=</span> <span class="nv">TermData</span><span class="p">,</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">KvState1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">tanodb_kv_ets</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">KvState</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">),</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">kv_state</span><span class="o">=</span><span class="nv">KvState1</span><span class="p">}}.</span>

<span class="nf">encode_handoff_item</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nb">term_to_binary</span><span class="p">({</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}).</span>

<span class="nf">is_empty</span><span class="p">(</span><span class="nv">State</span><span class="o">=</span><span class="nl">#state</span><span class="p">{</span><span class="n">kv_state</span><span class="o">=</span><span class="nv">KvState</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="nv">Partition</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">IsEmpty</span><span class="p">,</span> <span class="nv">KvState1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">tanodb_kv_ets</span><span class="p">:</span><span class="nf">is_empty</span><span class="p">(</span><span class="nv">KvState</span><span class="p">),</span>
    <span class="nn">lager</span><span class="p">:</span><span class="nf">info</span><span class="p">(</span><span class="s">&quot;is_empty </span><span class="si">~p</span><span class="s">: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Partition</span><span class="p">,</span> <span class="nv">IsEmpty</span><span class="p">]),</span>
    <span class="p">{</span><span class="nv">IsEmpty</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">kv_state</span><span class="o">=</span><span class="nv">KvState1</span><span class="p">}}.</span>

<span class="nf">delete</span><span class="p">(</span><span class="nv">State</span><span class="o">=</span><span class="nl">#state</span><span class="p">{</span><span class="n">kv_state</span><span class="o">=</span><span class="nv">KvState</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="nv">Partition</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nn">lager</span><span class="p">:</span><span class="nf">info</span><span class="p">(</span><span class="s">&quot;delete </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Partition</span><span class="p">]),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">KvState1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">tanodb_kv_ets</span><span class="p">:</span><span class="nf">dispose</span><span class="p">(</span><span class="nv">KvState</span><span class="p">),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">KvState2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">tanodb_kv_ets</span><span class="p">:</span><span class="nf">delete</span><span class="p">(</span><span class="nv">KvState1</span><span class="p">),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">kv_state</span><span class="o">=</span><span class="nv">KvState2</span><span class="p">}}.</span>
</pre></div>
</div>
</div>
<div class="section" id="trying-it">
<h2>Trying it<a class="headerlink" href="#trying-it" title="Permalink to this headline">¶</a></h2>
<p>To test it we will first start a devrel node, put some values and then join
two other nodes and see on the console the handoff happening.</p>
<p>To make sure the nodes don’t know about each other in case you played with
clustering already we will start by removing the devrel builds:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>rm -rf _build/dev*
</pre></div>
</div>
<p>And build the nodes again:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>make devrel
</pre></div>
</div>
<p>Now we will start the first node and connect to its console:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>make dev1-console
</pre></div>
</div>
<p>We generate a list of some numbers:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb1</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">Nums</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span>

<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<p>And with it create some bucket names:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb1</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">2</span><span class="o">&gt;</span>
<span class="nv">Buckets</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nb">list_to_binary</span><span class="p">(</span><span class="s">&quot;bucket-&quot;</span> <span class="o">++</span> <span class="nb">integer_to_list</span><span class="p">(</span><span class="nv">N</span><span class="p">))</span>
<span class="k">end</span><span class="p">,</span> <span class="nv">Nums</span><span class="p">).</span>

<span class="p">[</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket-1&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket-2&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket-3&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;&lt;</span><span class="s">&quot;bucket-4&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket-5&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket-6&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket-7&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;&lt;</span><span class="s">&quot;bucket-8&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket-9&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;bucket-10&quot;</span><span class="o">&gt;&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>And some key names:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb1</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">3</span><span class="o">&gt;</span>
<span class="nv">Keys</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nb">list_to_binary</span><span class="p">(</span><span class="s">&quot;key-&quot;</span> <span class="o">++</span> <span class="nb">integer_to_list</span><span class="p">(</span><span class="nv">N</span><span class="p">))</span>
<span class="k">end</span><span class="p">,</span> <span class="nv">Nums</span><span class="p">).</span>

<span class="p">[</span><span class="o">&lt;&lt;</span><span class="s">&quot;key-1&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;key-2&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;key-3&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;key-4&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;&lt;</span><span class="s">&quot;key-5&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;key-6&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;key-7&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;key-8&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;key-9&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;&lt;</span><span class="s">&quot;key-10&quot;</span><span class="o">&gt;&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>We create a function to generate a value from a bucket and a key:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb1</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">4</span><span class="o">&gt;</span>
<span class="nv">GenValue</span> <span class="o">=</span> <span class="k">fun</span> <span class="p">(</span><span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[{</span><span class="n">bucket</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">},</span> <span class="p">{</span><span class="n">key</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}]</span> <span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>And then put some values to the buckets and keys we created:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb1</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">5</span><span class="o">&gt;</span>
<span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nv">Val</span> <span class="o">=</span> <span class="nv">GenValue</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Key</span><span class="p">),</span>
        <span class="nn">tanodb</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">)</span>
    <span class="k">end</span><span class="p">,</span> <span class="nv">Keys</span><span class="p">)</span>
<span class="k">end</span><span class="p">,</span> <span class="nv">Buckets</span><span class="p">).</span>

<span class="n">ok</span>
</pre></div>
</div>
<p>Now that we have some data let’s start the other two nodes:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>make dev2-console
</pre></div>
</div>
<p>In yet another shell:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>make dev3-console
</pre></div>
</div>
<p>This part should remind you of the first chapter:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>make devrel-join
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Success</span><span class="p">:</span> <span class="n">staged</span> <span class="n">join</span> <span class="n">request</span> <span class="k">for</span> <span class="s1">&#39;tanodb2@127.0.0.1&#39;</span> <span class="n">to</span> <span class="s1">&#39;tanodb1@127.0.0.1&#39;</span>
<span class="n">Success</span><span class="p">:</span> <span class="n">staged</span> <span class="n">join</span> <span class="n">request</span> <span class="k">for</span> <span class="s1">&#39;tanodb3@127.0.0.1&#39;</span> <span class="n">to</span> <span class="s1">&#39;tanodb1@127.0.0.1&#39;</span>
</pre></div>
</div>
<div class="highlight-sh"><div class="highlight"><pre><span></span>make devrel-cluster-plan
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">===============================</span> <span class="n">Staged</span> <span class="n">Changes</span> <span class="o">=========================</span>
<span class="n">Action</span>         <span class="n">Details</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="o">------------------------------------------------------------------------</span>
<span class="n">join</span>           <span class="s1">&#39;tanodb2@127.0.0.1&#39;</span>
<span class="n">join</span>           <span class="s1">&#39;tanodb3@127.0.0.1&#39;</span>
<span class="o">------------------------------------------------------------------------</span>


<span class="n">NOTE</span><span class="p">:</span> <span class="n">Applying</span> <span class="n">these</span> <span class="n">changes</span> <span class="n">will</span> <span class="n">result</span> <span class="ow">in</span> <span class="mi">1</span> <span class="n">cluster</span> <span class="n">transition</span>

<span class="c1">########################################################################</span>
                         <span class="n">After</span> <span class="n">cluster</span> <span class="n">transition</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>
<span class="c1">########################################################################</span>

<span class="o">=================================</span> <span class="n">Membership</span> <span class="o">===========================</span>
<span class="n">Status</span>     <span class="n">Ring</span>    <span class="n">Pending</span>    <span class="n">Node</span>
<span class="o">------------------------------------------------------------------------</span>
<span class="n">valid</span>     <span class="mf">100.0</span><span class="o">%</span>     <span class="mf">34.4</span><span class="o">%</span>    <span class="s1">&#39;tanodb1@127.0.0.1&#39;</span>
<span class="n">valid</span>       <span class="mf">0.0</span><span class="o">%</span>     <span class="mf">32.8</span><span class="o">%</span>    <span class="s1">&#39;tanodb2@127.0.0.1&#39;</span>
<span class="n">valid</span>       <span class="mf">0.0</span><span class="o">%</span>     <span class="mf">32.8</span><span class="o">%</span>    <span class="s1">&#39;tanodb3@127.0.0.1&#39;</span>
<span class="o">------------------------------------------------------------------------</span>
<span class="n">Valid</span><span class="p">:</span><span class="mi">3</span> <span class="o">/</span> <span class="n">Leaving</span><span class="p">:</span><span class="mi">0</span> <span class="o">/</span> <span class="n">Exiting</span><span class="p">:</span><span class="mi">0</span> <span class="o">/</span> <span class="n">Joining</span><span class="p">:</span><span class="mi">0</span> <span class="o">/</span> <span class="n">Down</span><span class="p">:</span><span class="mi">0</span>

<span class="n">WARNING</span><span class="p">:</span> <span class="n">Not</span> <span class="nb">all</span> <span class="n">replicas</span> <span class="n">will</span> <span class="n">be</span> <span class="n">on</span> <span class="n">distinct</span> <span class="n">nodes</span>

<span class="n">Transfers</span> <span class="n">resulting</span> <span class="kn">from</span> <span class="nn">cluster</span> <span class="n">changes</span><span class="p">:</span> <span class="mi">42</span>
  <span class="mi">21</span> <span class="n">transfers</span> <span class="kn">from</span> <span class="s1">&#39;tanodb1@127.0.0.1&#39;</span> <span class="n">to</span> <span class="s1">&#39;tanodb3@127.0.0.1&#39;</span>
  <span class="mi">21</span> <span class="n">transfers</span> <span class="kn">from</span> <span class="s1">&#39;tanodb1@127.0.0.1&#39;</span> <span class="n">to</span> <span class="s1">&#39;tanodb2@127.0.0.1&#39;</span>
</pre></div>
</div>
<div class="highlight-sh"><div class="highlight"><pre><span></span>make devrel-cluster-commit
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">changes</span> <span class="n">committed</span>
</pre></div>
</div>
<p>On the consoles from the nodes you should see some logs like the following, I
will just paste some as example.</p>
<p>On the sending side:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">00</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">24.240</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">ownership</span> <span class="n">transfer</span> <span class="n">of</span> <span class="n">tanodb_vnode</span> <span class="kn">from</span>
<span class="s1">&#39;tanodb1@127.0.0.1&#39;</span> <span class="mi">1118962191081472546749696200048404186924073353216</span> <span class="n">to</span>
<span class="s1">&#39;tanodb2@127.0.0.1&#39;</span> <span class="mi">1118962191081472546749696200048404186924073353216</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">24.240</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">fold</span> <span class="n">req</span> <span class="mi">1118962191081472546749696200048404186924073353216</span>
<span class="mi">00</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">24.240</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">fold</span> <span class="n">fun</span> <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s2">&quot;bucket-1&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;key-1&quot;</span><span class="o">&gt;&gt;</span><span class="p">}:</span>
    <span class="p">[{</span><span class="n">bucket</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;bucket-1&quot;</span><span class="o">&gt;&gt;</span><span class="p">},{</span><span class="n">key</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;key-1&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]</span>

<span class="o">...</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">24.241</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">fold</span> <span class="n">fun</span> <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s2">&quot;bucket-7&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;key-8&quot;</span><span class="o">&gt;&gt;</span><span class="p">}:</span>
    <span class="p">[{</span><span class="n">bucket</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;bucket-7&quot;</span><span class="o">&gt;&gt;</span><span class="p">},{</span><span class="n">key</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;key-8&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">24.281</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">ownership</span> <span class="n">transfer</span> <span class="n">of</span> <span class="n">tanodb_vnode</span> <span class="kn">from</span>
<span class="s1">&#39;tanodb1@127.0.0.1&#39;</span> <span class="mi">1118962191081472546749696200048404186924073353216</span> <span class="n">to</span>
<span class="s1">&#39;tanodb2@127.0.0.1&#39;</span> <span class="mi">1118962191081472546749696200048404186924073353216</span>
    <span class="n">completed</span><span class="p">:</span> <span class="n">sent</span> <span class="mf">575.00</span> <span class="n">B</span> <span class="nb">bytes</span> <span class="ow">in</span> <span class="mi">7</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">objects</span> <span class="ow">in</span> <span class="mf">0.04</span> <span class="n">seconds</span>
    <span class="p">(</span><span class="mf">13.67</span> <span class="n">KB</span><span class="o">/</span><span class="n">second</span><span class="p">)</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">24.280</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">handoff</span> <span class="n">finished</span>
    <span class="mi">1141798154164767904846628775559596109106197299200</span><span class="p">:</span>
    <span class="p">{</span><span class="mi">1141798154164767904846628775559596109106197299200</span><span class="p">,</span>
        <span class="s1">&#39;tanodb3@127.0.0.1&#39;</span><span class="p">}</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">24.285</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">delete</span>
    <span class="mi">1141798154164767904846628775559596109106197299200</span>
</pre></div>
</div>
<p>On the receiving side:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">00</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">59.641</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">handoff</span> <span class="n">starting</span>
    <span class="mi">1050454301831586472458898473514828420377701515264</span><span class="p">:</span>
    <span class="p">{</span><span class="n">hinted</span><span class="p">,{</span><span class="mi">1050454301831586472458898473514828420377701515264</span><span class="p">,</span>
        <span class="s1">&#39;tanodb1@127.0.0.1&#39;</span><span class="p">}}</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">59.641</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">is_empty</span>
    <span class="mi">182687704666362864775460604089535377456991567872</span><span class="p">:</span> <span class="n">true</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">34.259</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">Receiving</span> <span class="n">handoff</span> <span class="n">data</span> <span class="k">for</span> <span class="n">partition</span>
    <span class="n">tanodb_vnode</span><span class="p">:</span><span class="mi">68507889249886074290797726533575766546371837952</span> <span class="kn">from</span>
    <span class="p">{</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="mi">47440</span><span class="p">}</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">34.296</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">handoff</span> <span class="n">data</span> <span class="n">received</span>
    <span class="p">{{</span><span class="o">&lt;&lt;</span><span class="s2">&quot;bucket-8&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;key-1&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
        <span class="p">[{</span><span class="n">bucket</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;bucket-8&quot;</span><span class="o">&gt;&gt;</span><span class="p">},{</span><span class="n">key</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;key-1&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]}</span>

<span class="o">...</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">34.297</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">handoff</span> <span class="n">data</span> <span class="n">received</span>
    <span class="p">{{</span><span class="o">&lt;&lt;</span><span class="s2">&quot;bucket-3&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;key-7&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
        <span class="p">[{</span><span class="n">bucket</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;bucket-3&quot;</span><span class="o">&gt;&gt;</span><span class="p">},{</span><span class="n">key</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s2">&quot;key-7&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]}</span>

<span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">34.298</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="n">Handoff</span> <span class="n">receiver</span> <span class="k">for</span> <span class="n">partition</span>
    <span class="mi">68507889249886074290797726533575766546371837952</span> <span class="n">exited</span> <span class="n">after</span>
    <span class="n">processing</span> <span class="mi">5</span> <span class="n">objects</span> <span class="kn">from</span> <span class="p">{</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="mi">47440</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Handoff</a><ul>
<li><a class="reference internal" href="#how-it-works">How it Works</a></li>
<li><a class="reference internal" href="#implementing-it">Implementing it</a></li>
<li><a class="reference internal" href="#trying-it">Trying it</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="quorum-requests.html" title="previous chapter">Quorum Requests</a></li>
      <li>Next: <a href="coverage-calls.html" title="next chapter">Coverage Calls</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/handoff.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Mariano Guerra.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.7</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="_sources/handoff.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>