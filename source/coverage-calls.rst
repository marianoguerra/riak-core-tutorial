Coverage Calls
==============

How it Works
------------

Implementing it
---------------

tanodb.erl

.. code-block:: erlang

	keys(Bucket) ->
		Timeout = 5000,
		tanodb_coverage_fsm:start({keys, Bucket}, Timeout).


tanodb_vnode.erl

.. code-block:: erlang

	handle_coverage({keys, Bucket}, _KeySpaces, {_, RefId, _},
					State=#state{table_id=TableId}) ->
		Keys0 = ets:match(TableId, {{Bucket, '$1'}, '_'}),
		Keys = lists:map(fun first/1, Keys0),
		{reply, {RefId, Keys}, State};

Add tanodb_coverage_fsm and tanodb_coverage_fsm_sup.
Add tanodb_coverage_fsm_sup to tanodb_sup

Testing it
----------

.. code-block:: erlang

	Nums = lists:seq(1, 10).
	Buckets = lists:map(fun (N) -> list_to_binary("bucket-" ++ integer_to_list(N)) end,
	Nums).
	Keys = lists:map(fun (N) -> list_to_binary("key-" ++ integer_to_list(N)) end, Nums).

	GenValue = fun (Bucket, Key) -> [{bucket, Bucket}, {key, Key}] end.

	lists:foreach(fun (Bucket) ->
		lists:foreach(fun (Key) ->
			Val = GenValue(Bucket, Key),
			tanodb:put({Bucket, Key}, Val)
		end, Keys)
	end, Buckets).

	{ok, Items} = tanodb:keys(<<"bucket-1">>).
	[{Partition, Node, Keys} || {Partition, Node, Keys} <- Items, Keys =/= []]. 

.. code-block:: erlang

	[{296867520082839655260123481645494988367611297792,
	  'tanodb@127.0.0.1', [<<"key-10">>]},
	 {365375409332725729550921208179070754913983135744,
	  'tanodb@127.0.0.1', [<<"key-4">>]},
	 {137015778499772148581595453067151533092743675904,
	  'tanodb@127.0.0.1', [<<"key-8">>]},
	 {707914855582156101004909840846949587645842325504,
	  'tanodb@127.0.0.1', [<<"key-9">>]},
	 {45671926166590716193865151022383844364247891968,
	  'tanodb@127.0.0.1', [<<"key-2">>]},
	 {753586781748746817198774991869333432010090217472,
	  'tanodb@127.0.0.1', [<<"key-9">>]},
	 {274031556999544297163190906134303066185487351808,
	  'tanodb@127.0.0.1', [<<"key-10">>]},
	 {822094670998632891489572718402909198556462055424,
	  'tanodb@127.0.0.1', [<<"key-5">>]},
	 {319703483166135013357056057156686910549735243776,
	  'tanodb@127.0.0.1', [<<"key-4">>,<<"key-10">>]},
	 {342539446249430371453988632667878832731859189760,
	  'tanodb@127.0.0.1', [<<"key-4">>]},
	 {68507889249886074290797726533575766546371837952,
	  'tanodb@127.0.0.1', [<<"key-2">>]},
	 {799258707915337533392640142891717276374338109440,
	  'tanodb@127.0.0.1', [<<"key-5">>]},
	 {91343852333181432387730302044767688728495783936,
	  'tanodb@127.0.0.1', [<<"key-2">>]},
	 {730750818665451459101842416358141509827966271488,
	  'tanodb@127.0.0.1', [<<"key-9">>]},
	 {159851741583067506678528028578343455274867621888,
	  'tanodb@127.0.0.1', [<<"key-8">>]},
	 {182687704666362864775460604089535377456991567872,
	  'tanodb@127.0.0.1', [<<"key-8">>]},
	 {844930634081928249586505293914101120738586001408,
	  'tanodb@127.0.0.1', [<<"key-5">>]},
	 {867766597165223607683437869425293042920709947392,
	  'tanodb@127.0.0.1', [<<"key-3">>]},
	 {890602560248518965780370444936484965102833893376,
	  'tanodb@127.0.0.1', [<<"key-3">>]},
	 {1050454301831586472458898473514828420377701515264,
	  'tanodb@127.0.0.1', [<<"key-6">>]},
	 {913438523331814323877303020447676887284957839360,
	  'tanodb@127.0.0.1', [<<"key-3">>]},
	 {1118962191081472546749696200048404186924073353216,
	  'tanodb@127.0.0.1', [<<"key-7">>,<<"key-1">>]},
	 {1164634117248063262943561351070788031288321245184,
	  'tanodb@127.0.0.1', [<<"key-7">>]},
	 {1027618338748291114361965898003636498195577569280,
	  'tanodb@127.0.0.1', [<<"key-"...>>]},
	 {1096126227998177188652763624537212264741949407232,
	  'tanodb@127.0.0.1', [<<...>>]},
	 {1073290264914881830555831049026020342559825461248,
	  'tanodb@127.0.0.1', [...]},
	 {1141798154164767904846628775559596109106197299200,
	  'tanodb@127.0.0.1',...}]
